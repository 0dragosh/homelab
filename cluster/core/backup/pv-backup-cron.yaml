---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: pv-backup
  namespace: backup
spec:
  schedule: "0 * * * *"
  concurrencyPolicy: "Forbid"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      ttlSecondsAfterFinished: 300
      template:
        spec:
          serviceAccountName: sa-pv-backup
          automountServiceAccountToken: true
          restartPolicy: OnFailure
          containers:
            - name: pv-backup
              image: busybox:latest
              command:
                - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                - curl -LO "https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64"
                - chmod +x kubectl
                - chmod +x jq-linux64
                - mv kubectl /usr/local/bin/
                - mv jq-linux64 /usr/local/bin/jq
                - curl -LO "https://github.com/utkuozdemir/pv-migrate/releases/download/v0.8.1/pv-migrate_v0.8.1_linux_x86_64.tar.gz"
                - tar xvf pv-migrate*
                - mv pv-migrate /usr/local/bin/
                - /pv-backup.sh
              env:
                - name: DESTINATION_NAMESPACE
                  value: backup
                - name: DESTINATION_PVC_NAME
                  value: nfs-backups-pvc
              volumeMounts:
                - mountPath: /pv-backup.sh
                  name: pv-backup
          volumes:
            - name: pv-backup
              projected:
                defaultMode: 0775
                sources:
                  - configMap:
                      name: pv-backup
