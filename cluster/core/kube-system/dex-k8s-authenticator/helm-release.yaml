---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: dex-k8s-authenticator
  namespace: kube-system
spec:
  releaseName: dex-k8s-authenticator
  interval: 5m
  chart:
    spec:
      chart: ./charts/dex-k8s-authenticator
      version: 1.4.0
      sourceRef:
        kind: GitRepository
        name: mintel-dex-charts-git
        namespace: flux-system
      interval: 5m
  values:
    global:
      deployEnv: prod
    image:
      repository: mintel/dex-k8s-authenticator
      tag: 1.4.0
    ingress:
      enabled: false
    resources:
      requests:
        memory: 350Mi
        cpu: 25m
      limits:
        memory: 500Mi
    dexK8sAuthenticator:
      clusters:
        - name: homelab
          short_description: "Homelab"
          description: "Homelab"
          client_secret: ${SECRET_DEX_K8S_AUTHENTICATOR_CLIENT_SECRET}
          issuer: https://dex.${SECRET_DOMAIN}
          k8s_master_uri: https://${KUBE_VIP_ADDRESS}:6443
          client_id: dex-k8s-authenticator
          redirect_uri: https://login.${SECRET_DOMAIN}/callback/
          k8s_ca_pem: |
            -----BEGIN CERTIFICATE-----
            MIIBdzCCAR2gAwIBAgIBADAKBggqhkjOPQQDAjAjMSEwHwYDVQQDDBhrM3Mtc2Vy
            dmVyLWNhQDE2MjU1MTU0NDUwHhcNMjEwNzA1MjAwNDA1WhcNMzEwNzAzMjAwNDA1
            WjAjMSEwHwYDVQQDDBhrM3Mtc2VydmVyLWNhQDE2MjU1MTU0NDUwWTATBgcqhkjO
            PQIBBggqhkjOPQMBBwNCAAQG/fGTGDibIB0/Av6OQcwJPduEvsh+PKdANrQjfHk8
            3cB1mVjRwPHo1O4TygmZBt0Ei2GNong/t/nZ/nuq1C9vo0IwQDAOBgNVHQ8BAf8E
            BAMCAqQwDwYDVR0TAQH/BAUwAwEB/zAdBgNVHQ4EFgQUow+y4o5rtYAhpIKIFRBV
            CPUlzE4wCgYIKoZIzj0EAwIDSAAwRQIgUA+SiTcbITu45px3d30lgblqsJvY0Mw7
            C9uCCRqJPEoCIQDYjrKOCzpiIOuiUSCYYw4RTLveO+taliNKsA79zQ2Hrg==
            -----END CERTIFICATE-----
