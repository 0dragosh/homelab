---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: plex-autoskip
  namespace: media
  labels:
    app: plex-autoskip
spec:
  replicas: 1
  selector:
    matchLabels:
      app: plex-autoskip
  template:
    metadata:
      labels:
        app: plex-autoskip
    spec:
      dnsPolicy: ClusterFirstWithHostNet
      containers:
        - name: plex-autoskip
          image: ghcr.io/mdhiggins/plexautoskip-docker:latest
#          command: ["/bin/bash"]
#          args: ["-m", "-c", ""]
          imagePullPolicy: IfNotPresent
          env:
            - name: TZ
              value: ${TZ}
          volumeMounts:
            - mountPath: /config
              name: plex-autoskip-cm
          resources: {}
      hostNetwork: true
      volumes:
        - name: plex-autoskip-cm
          projected:
            defaultMode: 0775
            sources:
              - configMap:
                  name: plex-autoskip-cm
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: plex-autoskip-cm
  namespace: media
data:
  config.ini: |
    [Plex.tv]
    username=${SECRET_PLEX_USERNAME}
    token=${SECRET_PLEX_TOKEN}
    servername=${SECRET_PLEX_SERVER_NAME}

    [Server]
    address=plex.media
    ssl=False
    port=32400

    [Security]
    ignore-certs=True

    [Offsets]
    start=3000
    end=500

  logging.ini: |
    [loggers]
    keys = root

    [handlers]
    keys = consoleHandler, fileHandler

    [formatters]
    keys = simpleFormatter, minimalFormatter

    [logger_root]
    level = DEBUG
    handlers = consoleHandler, fileHandler

    [handler_consoleHandler]
    class = StreamHandler
    level = INFO
    formatter = minimalFormatter
    args = (sys.stdout,)

    [handler_fileHandler]
    class = handlers.RotatingFileHandler
    level = INFO
    formatter = simpleFormatter
    args = ('%(logfilename)s', 'a', 100000, 3, 'utf-8')

    [formatter_simpleFormatter]
    format = %(asctime)s - %(name)s - %(levelname)s - %(message)s
    datefmt = %Y-%m-%d %H:%M:%S

    [formatter_minimalFormatter]
    format = %(levelname)s - %(message)s

  custom.json: |
    {
      "markers": {
        "9999999":
        [
          {
            "start": 0,
            "end": 20000
          }
        ]
      },
      "blocked": {
        "keys": [
        ],
        "parents": [
        ],
        "grandparents": [
        ]
      },
      "allowed": {
        "keys": [
        ],
        "parents": [
        ],
        "grandparents": [
        ]
      }
    }
