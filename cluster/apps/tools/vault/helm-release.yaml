---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: vault
  namespace: tools
spec:
  interval: 5m
  chart:
    spec:
      chart: vault
      version: 0.16.1
      sourceRef:
        kind: HelmRepository
        name: hashicorp-charts
        namespace: flux-system
  values:
    vault:
      ui:
        enabled: true
      csi:
        enabled: true
      server:
        image:
          repository: "vault"
          tag: "1.8.4"
          pullPolicy: IfNotPresent
        ha:
          enabled: true
        injector:
          enabled: true
        extraSecretEnvironmentVars:
          - envName: VAULT_PG_CONNECTION_URL
            secretName: vault-secret
            secretKey: VAULT_PG_CONNECTION_URL
          - envName: AWS_SECRET_ACCESS_KEY
            secretName: vault-secret
            secretKey: AWS_SECRET_ACCESS_KE
          - envName: AWS_SECRET_ACCESS_KEY
            secretName: vault-secret
            secretKey: AWS_SECRET_ACCESS_KEY
          - envName: AWS_ACCESS_KEY_ID
            secretName: vault-secret
            secretKey: AWS_ACCESS_KEY_ID
          - envName: AWS_DEFAULT_REGION
            secretName: vault-secret
            secretKey: AWS_DEFAULT_REGION
          - envName: VAULT_AWSKMS_SEAL_KEY_ID
            secretName: vault-secret
            secretKey: VAULT_AWSKMS_SEAL_KEY_ID

        config: |
          ui = true
          listener "tcp" {
            tls_disable = 1
            address = "[::]:8200"
            cluster_address = "[::]:8201"
          }
          storage "postgresql" {
            ha_enabled = true
            ha_table = "vault_ha_locks"
            table = "vault_kv_store"
          }
          service_registration "kubernetes" {}
          seal "awskms" {}
        ingress:
          enabled: true
          annotations:
            traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
            external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
            external-dns.alpha.kubernetes.io/target: "${SECRET_CLOUDFLARE_TUNNEL_ID_1}.cfargotunnel.com"
          hosts:
            - host: "vault.${SECRET_DOMAIN}"
              paths: [ / ]
          tls:
            - hosts: [ "vault.${SECRET_DOMAIN}" ]
        resources:
          requests:
            memory: 256Mi
            cpu: 100m
          limits:
            memory: 512MI
            cpu: 0.5
        dataStorage:
          size: 5Gi
          storageClass: longhorn
