---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: vsphere-csi
  namespace: vmware-system-csi
spec:
  interval: 5m
  install:
    disableWait: true
    remediation:
      retries: 100
  upgrade:
    remediation:
      retries: 100
  chart:
    spec:
      # renovate: registryUrl=https://vsphere-tmm.github.io/helm-charts
      chart: vsphere-csi
      version: 2.1.1
      sourceRef:
        kind: HelmRepository
        name: vsphere-tmm
        namespace: flux-system
  values:
    vsphere-cpi:
      enabled: true
    controller:
      ## @param controller.name name used for the deployment, if unset defaults to "{{ template "common.names.fullname" . }}"
      name: vsphere-csi-controller
      ## @param controller.config block to freely define options for the controller configmap
      ## see https://github.com/kubernetes-sigs/vsphere-csi-driver/blob/61d981a1a1641693a2a6727e1994c82d26fed14b/pkg/csi/service/common/constants.go#L258
      config:
        csi-migration: false
        csi-auth-check: true
        online-volume-extend: true
        trigger-csi-fullsync: false
        async-query-volume: true
        improved-csi-idempotency: true
        improved-volume-topology: true
    global:
      config:
        storageclass:
          enabled: true
          expansion: true
        vcenter:
          vcsa:
            server: "${VCENTER_ADDRESS}"
            user: "${VCENTER_CSI_USER}"
            password: "${VCENTER_CSI_PASSWORD}"
            datacenters:
              - "${VCENTER_DATACENTER}"
